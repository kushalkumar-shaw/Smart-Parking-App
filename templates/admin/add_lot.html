{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-plus"></i> Add New Parking Lot</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="location" class="form-label">Location Name</label>
                                <input type="text" class="form-control" id="location" name="location" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="price" class="form-label">Price per Hour (â‚¹)</label>
                                <input type="number" step="0.01" class="form-control" id="price" name="price" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea class="form-control" id="address" name="address" rows="2" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pin_code" class="form-label">Pin Code</label>
                                <input type="text" class="form-control" id="pin_code" name="pin_code" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="spots" class="form-label">Number of Parking Spots</label>
                                <input type="number" min="1" class="form-control" id="spots" name="spots" required>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Select Parking Lot Location</strong><br>
                        <small>Click on the map to select the exact location of the parking lot. You can also drag the marker to adjust.</small>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary mb-2" id="useMyLocation">
                            <i class="fas fa-crosshairs"></i> Use My Current Location
                        </button>
                        <div id="pickMap" style="height: 450px; width: 100%; border-radius: 8px; border: 2px solid #ddd;"></div>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <div class="mt-2">
                            <small id="selectedCoords" class="text-muted">Click on the map to select location</small>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Add Parking Lot
                        </button>
                    </div>
                </form>
                </div>
        </div>
    </div>
</div>

<script>
let pickMap;
let marker;

function initMap() {
    // Default center (India)
    const defaultCenter = { lat: 20.5937, lng: 78.9629 };
    
    pickMap = new google.maps.Map(document.getElementById('pickMap'), {
        zoom: 12,
        center: defaultCenter,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true
    });

    // Try to get user's current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                pickMap.setCenter(userLocation);
                pickMap.setZoom(15);
                
                // Place initial marker at user's location
                placeMarker(userLocation);
            },
            (error) => {
                console.log('Geolocation error:', error);
            }
        );
    }

    // Add click listener to map
    pickMap.addListener('click', (event) => {
        placeMarker(event.latLng);
    });
}

function placeMarker(location) {
    // Remove old marker if exists
    if (marker) {
        marker.setMap(null);
    }

    // Create new marker
    marker = new google.maps.Marker({
        position: location,
        map: pickMap,
        draggable: true,
        animation: google.maps.Animation.DROP
    });

    // Update coordinates when marker is dragged
    marker.addListener('dragend', (event) => {
        updateCoordinates(event.latLng.lat(), event.latLng.lng());
    });

    // Update coordinates
    updateCoordinates(location.lat(), location.lng());
}

function updateCoordinates(lat, lng) {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    document.getElementById('selectedCoords').innerHTML = 
        `<i class="fas fa-map-marker-alt text-primary"></i> <strong>Selected:</strong> Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
}

// Use My Current Location button
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('useMyLocation').addEventListener('click', function() {
        if (navigator.geolocation) {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
            const btn = this;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (pickMap) {
                        pickMap.setCenter(userLocation);
                        pickMap.setZoom(15);
                        placeMarker(userLocation);
                    }
                    
                    btn.innerHTML = '<i class="fas fa-check"></i> Location Detected!';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-crosshairs"></i> Use My Current Location';
                    }, 2000);
                },
                (error) => {
                    alert('Unable to detect location. Please enable location access.');
                    btn.innerHTML = '<i class="fas fa-crosshairs"></i> Use My Current Location';
                }
            );
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    });
});

// Initialize map when Google Maps API is loaded
window.initMap = initMap;
</script>

<!-- Google Maps API -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap">
</script>
{% endblock %}