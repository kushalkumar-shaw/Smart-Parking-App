{% extends "base.html" %}
{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <h2><i class="fas fa-map-marked-alt"></i> Find Parking Locations</h2>
        <p class="text-muted">Explore parking lots near you on the map</p>
    </div>
</div>

<!-- Map Container -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body p-0">
                <div id="map" style="height: 500px; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Parking Lot Cards -->
<div class="row">
    <div class="col-md-12">
        <h4 class="mb-3">Available Parking Lots</h4>
        <div id="parking-lots-list" class="row">
            <!-- Parking lot cards will be populated here -->
        </div>
    </div>
</div>

<script>
let map;
let markers = [];
let infoWindows = [];

function initMap() {
    // Default center (India)
    const defaultCenter = { lat: 20.5937, lng: 78.9629 };
    
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 6,
        center: defaultCenter,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true
    });

    // Fetch parking lots from API
    fetch('/api/parking-lots')
        .then(response => response.json())
        .then(data => {
            if (data.lots && data.lots.length > 0) {
                displayParkingLots(data.lots);
                
                // If user has location, center on their position
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            // Add user marker
                            new google.maps.Marker({
                                position: userLocation,
                                map: map,
                                icon: {
                                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                                },
                                title: 'Your Location'
                            });
                            
                            map.setCenter(userLocation);
                            map.setZoom(12);
                        },
                        () => {
                            // If we have parking lots, center on the first one
                            if (data.lots[0].latitude && data.lots[0].longitude) {
                                map.setCenter({ 
                                    lat: data.lots[0].latitude, 
                                    lng: data.lots[0].longitude 
                                });
                                map.setZoom(12);
                            }
                        }
                    );
                } else if (data.lots[0].latitude && data.lots[0].longitude) {
                    // No geolocation support, center on first parking lot
                    map.setCenter({ 
                        lat: data.lots[0].latitude, 
                        lng: data.lots[0].longitude 
                    });
                    map.setZoom(12);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching parking lots:', error);
        });
}

function displayParkingLots(lots) {
    const listContainer = document.getElementById('parking-lots-list');
    listContainer.innerHTML = '';
    
    lots.forEach((lot, index) => {
        if (lot.latitude && lot.longitude) {
            // Add marker to map
            const marker = new google.maps.Marker({
                position: { lat: lot.latitude, lng: lot.longitude },
                map: map,
                title: lot.name,
                animation: google.maps.Animation.DROP,
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                }
            });

            // Create info window
            const availableSpots = lot.available_spots;
            const totalSpots = lot.total_spots;
            const availabilityClass = availableSpots > 0 ? 'success' : 'danger';
            
            const infoWindowContent = `
                <div style="padding: 10px; max-width: 250px;">
                    <h6 style="margin-bottom: 10px; color: #007bff;">${lot.name}</h6>
                    <p style="margin-bottom: 5px; font-size: 0.9em;">${lot.address}, ${lot.pin_code}</p>
                    <p style="margin-bottom: 5px;"><strong>Rate:</strong> ₹${lot.price}/hour</p>
                    <p style="margin-bottom: 10px;">
                        <strong>Available:</strong> 
                        <span class="badge bg-${availabilityClass}">${availableSpots}/${totalSpots}</span>
                    </p>
                    ${availableSpots > 0 && !{{ 'true' if active_reservations else 'false' }} ? 
                        `<a href="/user/book_spot/${lot.id}" class="btn btn-success btn-sm" onclick="return confirm('Book a parking spot in ${lot.name}?')">
                            <i class="fas fa-car"></i> Book Now
                        </a>` : 
                        availableSpots === 0 ? 
                        '<button class="btn btn-danger btn-sm" disabled>Full</button>' :
                        '<button class="btn btn-secondary btn-sm" disabled>Already Booked</button>'
                    }
                </div>
            `;

            const infoWindow = new google.maps.InfoWindow({
                content: infoWindowContent
            });

            marker.addListener('click', () => {
                // Close all other info windows
                infoWindows.forEach(iw => iw.close());
                infoWindow.open(map, marker);
            });

            markers.push(marker);
            infoWindows.push(infoWindow);
        }

        // Add card to list
        const availableSpots = lot.available_spots;
        const totalSpots = lot.total_spots;
        const availabilityClass = availableSpots > 0 ? 'success' : 'danger';
        
        const card = `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 ${lot.latitude && lot.longitude ? 'border-primary' : ''}">
                    <div class="card-body">
                        <h6 class="card-title">
                            ${lot.name}
                            ${lot.latitude && lot.longitude ? '<i class="fas fa-map-marker-alt text-primary ms-1"></i>' : ''}
                        </h6>
                        <p class="card-text">
                            <small class="text-muted">${lot.address}, ${lot.pin_code}</small>
                        </p>
                        <p class="mb-2">
                            <strong>Rate:</strong> ₹${lot.price}/hour<br>
                            <strong>Available:</strong> 
                            <span class="badge bg-${availabilityClass}">
                                ${availableSpots}/${totalSpots}
                            </span>
                        </p>
                        ${lot.latitude && lot.longitude ? 
                            `<button class="btn btn-outline-primary btn-sm mb-2" onclick="focusOnMarker(${index})">
                                <i class="fas fa-map-pin"></i> Show on Map
                            </button><br>` : ''
                        }
                        ${availableSpots > 0 && !{{ 'true' if active_reservations else 'false' }} ? 
                            `<a href="/user/book_spot/${lot.id}" class="btn btn-success btn-sm" onclick="return confirm('Book a parking spot in ${lot.name}?')">
                                <i class="fas fa-car"></i> Book Spot
                            </a>` : 
                            availableSpots === 0 ? 
                            '<button class="btn btn-danger btn-sm" disabled>No Spots Available</button>' :
                            '<button class="btn btn-secondary btn-sm" disabled>Already Booked</button>'
                        }
                    </div>
                </div>
            </div>
        `;
        
        listContainer.innerHTML += card;
    });
}

function focusOnMarker(index) {
    if (markers[index]) {
        map.setCenter(markers[index].getPosition());
        map.setZoom(15);
        // Close all info windows
        infoWindows.forEach(iw => iw.close());
        // Open the clicked marker's info window
        infoWindows[index].open(map, markers[index]);
        
        // Scroll to map
        document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}
</script>

<!-- Google Maps API -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap">
</script>

<style>
.card.border-primary {
    border-width: 2px;
}
</style>
{% endblock %}
